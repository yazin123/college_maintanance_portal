{% extends 'base.html' %}

{% block title %}View Report - College Maintenance Portal{% endblock %}

{% block extra_css %}
<style>
    .report-header {
        background-color: #f8f9fa;
        border-bottom: 2px solid #e9ecef;
        padding: 1.5rem 0;
    }
    
    .date-range-pill {
        background-color: #e9ecef;
        border-radius: 50rem;
        display: inline-block;
        padding: 0.25rem 0.75rem;
        font-size: 0.875rem;
    }
    
    .stat-card {
        border-radius: 0.5rem;
        box-shadow: 0 0.15rem 1.75rem rgba(0, 0, 0, 0.15);
        margin-bottom: 1.5rem;
    }
    
    .stat-value {
        font-size: 2rem;
        font-weight: 700;
    }
    
    .stat-label {
        font-size: 0.875rem;
        color: #6c757d;
        text-transform: uppercase;
    }
    
    .chart-container {
        position: relative;
        height: 350px;
        margin-bottom: 2rem;
    }
    
    .data-table th {
        background-color: #f8f9fa;
    }
    
    @media print {
        .no-print {
            display: none !important;
        }
        
        .container {
            width: 100%;
            max-width: 100%;
        }
        
        .card {
            border: none !important;
            box-shadow: none !important;
        }
        
        .page-break {
            page-break-before: always;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="container">
    <!-- Navigation and Actions -->
    <div class="row mb-4 no-print">
        <div class="col-lg-12">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="{% url 'home' %}">Home</a></li>
                    <li class="breadcrumb-item"><a href="{% url 'generate_report' %}">Generate Report</a></li>
                    <li class="breadcrumb-item active" aria-current="page">View Report</li>
                </ol>
            </nav>
            
            <div class="d-flex justify-content-between">
                <h1 class="h3">Maintenance Performance Report</h1>
                <div>
                    <button class="btn btn-outline-primary me-2" onclick="window.print()">
                        <i class="fas fa-print me-2"></i>Print
                    </button>
                    <button class="btn btn-outline-success me-2">
                        <i class="fas fa-file-excel me-2"></i>Export to Excel
                    </button>
                    <button class="btn btn-outline-danger">
                        <i class="fas fa-file-pdf me-2"></i>Save as PDF
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Report Content -->
    <div class="card">
        <div class="card-body">
            <!-- Report Header -->
            <div class="report-header text-center">
                <h2>Maintenance Performance Report</h2>
                <p class="date-range-pill">
                    <i class="fas fa-calendar-alt me-2"></i>
                    {{ report.start_date|date:"F d, Y" }} - {{ report.end_date|date:"F d, Y" }}
                </p>
                <p class="text-muted mb-0">
                    Generated by {{ report.generated_by.username }} on {{ report.generated_at|date:"F d, Y \a\t g:i A" }}
                </p>
            </div>
            
            <!-- Executive Summary -->
            <div class="my-4">
                <h3>Executive Summary</h3>
                <p>
                    This report provides an analysis of maintenance activities from 
                    <strong>{{ report.start_date|date:"F d, Y" }}</strong> to 
                    <strong>{{ report.end_date|date:"F d, Y" }}</strong>. 
                    During this period, a total of <strong>{{ report.total_requests }}</strong> maintenance requests 
                    were processed, with <strong>{{ report.completed_requests }}</strong> completed successfully.
                </p>
            </div>
            
            <!-- Key Metrics -->
            <div class="row mb-4">
                <div class="col-md-3">
                    <div class="stat-card bg-white p-3 text-center">
                        <div class="stat-value text-primary">{{ report.total_requests }}</div>
                        <div class="stat-label">Total Requests</div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="stat-card bg-white p-3 text-center">
                        <div class="stat-value text-success">{{ report.completed_requests }}</div>
                        <div class="stat-label">Completed</div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="stat-card bg-white p-3 text-center">
                        <div class="stat-value text-warning">{{ report.average_resolution_time|floatformat:1 }}</div>
                        <div class="stat-label">Avg. Hours to Resolve</div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="stat-card bg-white p-3 text-center">
                        <div class="stat-value text-info">
                            {% widthratio report.completed_requests report.total_requests 100 as completion_rate %}
                            {{ completion_rate }}<small>%</small>
                        </div>
                        <div class="stat-label">Completion Rate</div>
                    </div>
                </div>
            </div>
            
            <!-- Charts Section -->
            <div class="row">
                <div class="col-lg-6">
                    <div class="card mb-4">
                        <div class="card-header">
                            <h5 class="mb-0">Requests by Category</h5>
                        </div>
                        <div class="card-body">
                            <div class="chart-container">
                                <canvas id="categoriesChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="col-lg-6">
                    <div class="card mb-4">
                        <div class="card-header">
                            <h5 class="mb-0">Requests by Status</h5>
                        </div>
                        <div class="card-body">
                            <div class="chart-container">
                                <canvas id="statusChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="row">
                <div class="col-lg-6">
                    <div class="card mb-4">
                        <div class="card-header">
                            <h5 class="mb-0">Requests by Building</h5>
                        </div>
                        <div class="card-body">
                            <div class="chart-container">
                                <canvas id="buildingsChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="col-lg-6">
                    <div class="card mb-4">
                        <div class="card-header">
                            <h5 class="mb-0">Resolution Time Trend</h5>
                        </div>
                        <div class="card-body">
                            <div class="chart-container">
                                <canvas id="resolutionTimeChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Staff Performance -->
            <div class="page-break"></div>
            <div class="mt-5 mb-4">
                <h3>Staff Performance</h3>
                <p>
                    The table below summarizes the performance metrics for maintenance staff 
                    during the reporting period.
                </p>
            </div>
            
            <div class="card mb-4">
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-bordered data-table mb-0">
                            <thead>
                                <tr>
                                    <th>Staff Member</th>
                                    <th>Assigned Requests</th>
                                    <th>Completed</th>
                                    <th>Avg. Resolution Time (hours)</th>
                                    <th>Completion Rate</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>John Smith</td>
                                    <td>24</td>
                                    <td>22</td>
                                    <td>28.5</td>
                                    <td>91.7%</td>
                                </tr>
                                <tr>
                                    <td>Maria Garcia</td>
                                    <td>18</td>
                                    <td>16</td>
                                    <td>32.1</td>
                                    <td>88.9%</td>
                                </tr>
                                <tr>
                                    <td>Robert Johnson</td>
                                    <td>27</td>
                                    <td>25</td>
                                    <td>26.8</td>
                                    <td>92.6%</td>
                                </tr>
                                <tr>
                                    <td>Sarah Williams</td>
                                    <td>21</td>
                                    <td>19</td>
                                    <td>30.4</td>
                                    <td>90.5%</td>
                                </tr>
                                <tr>
                                    <td>David Brown</td>
                                    <td>19</td>
                                    <td>17</td>
                                    <td>33.2</td>
                                    <td>89.5%</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            
            <!-- Detailed Request Data -->
            <div class="page-break"></div>
            <div class="mt-5 mb-4">
                <h3>Request Details</h3>
                <p>
                    This section provides a detailed breakdown of all maintenance requests processed 
                    during the reporting period.
                </p>
            </div>
            
            <div class="card mb-4">
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-bordered data-table mb-0">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Title</th>
                                    <th>Category</th>
                                    <th>Building</th>
                                    <th>Requester</th>
                                    <th>Created</th>
                                    <th>Completed</th>
                                    <th>Status</th>
                                    <th>Resolution Time (hours)</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>#1032</td>
                                    <td>Water leak in dorm room</td>
                                    <td>Plumbing</td>
                                    <td>Building A</td>
                                    <td>student1</td>
                                    <td>Mar 01, 2025</td>
                                    <td>Mar 02, 2025</td>
                                    <td><span class="badge bg-success">Completed</span></td>
                                    <td>26.4</td>
                                </tr>
                                <tr>
                                    <td>#1033</td>
                                    <td>Light fixture not working</td>
                                    <td>Electrical</td>
                                    <td>Building B</td>
                                    <td>student2</td>
                                    <td>Mar 02, 2025</td>
                                    <td>Mar 03, 2025</td>
                                    <td><span class="badge bg-success">Completed</span></td>
                                    <td>24.2</td>
                                </tr>
                                <tr>
                                    <td>#1034</td>
                                    <td>AC not cooling properly</td>
                                    <td>HVAC</td>
                                    <td>Building C</td>
                                    <td>student3</td>
                                    <td>Mar 02, 2025</td>
                                    <td>Mar 04, 2025</td>
                                    <td><span class="badge bg-success">Completed</span></td>
                                    <td>48.0</td>
                                </tr>
                                <tr>
                                    <td>#1035</td>
                                    <td>Door handle loose</td>
                                    <td>Structural</td>
                                    <td>Building A</td>
                                    <td>student4</td>
                                    <td>Mar 03, 2025</td>
                                    <td>Mar 04, 2025</td>
                                    <td><span class="badge bg-success">Completed</span></td>
                                    <td>18.7</td>
                                </tr>
                                <tr>
                                    <td>#1036</td>
                                    <td>Clogged sink</td>
                                    <td>Plumbing</td>
                                    <td>Building D</td>
                                    <td>student5</td>
                                    <td>Mar 05, 2025</td>
                                    <td>Mar 06, 2025</td>
                                    <td><span class="badge bg-success">Completed</span></td>
                                    <td>22.1</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            
            <!-- Recommendations Section -->
            <div class="page-break"></div>
            <div class="mt-5 mb-4">
                <h3>Recommendations</h3>
                <p>
                    Based on the analysis of maintenance data for this period, the following 
                    recommendations are suggested:
                </p>
                
                <div class="card mb-4">
                    <div class="card-body">
                        <ul class="mb-0">
                            <li class="mb-2">
                                <strong>Preventive Maintenance for HVAC Systems:</strong> HVAC-related issues have the longest average resolution time. Schedule preventive maintenance before the summer season.
                            </li>
                            <li class="mb-2">
                                <strong>Electrical System Inspection in Building B:</strong> Building B has a higher rate of electrical issues compared to other buildings. A comprehensive inspection is recommended.
                            </li>
                            <li class="mb-2">
                                <strong>Staff Training:</strong> Consider providing additional training for plumbing-related issues to improve resolution times.
                            </li>
                            <li class="mb-2">
                                <strong>Inventory Management:</strong> Maintain higher stock levels of frequently used plumbing and electrical components to reduce wait times.
                            </li>
                            <li>
                                <strong>Request Assignment Strategy:</strong> Review the current assignment strategy to distribute workload more evenly among staff members.
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
            
            <!-- Report Footer -->
            <div class="text-center mt-5 mb-3">
                <p class="text-muted mb-0">
                    <small>College Maintenance Portal - {{ report.generated_at|date:"F d, Y" }}</small>
                </p>
                <p class="text-muted">
                    <small>Report ID: {{ report.id }}</small>
                </p>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Categories Chart
        const categoriesChart = new Chart(
            document.getElementById('categoriesChart'),
            {
                type: 'bar',
                data: {
                    labels: ['Plumbing', 'Electrical', 'HVAC', 'Structural', 'Others'],
                    datasets: [{
                        label: 'Number of Requests',
                        data: [32, 28, 20, 15, 14],
                        backgroundColor: [
                            'rgba(78, 115, 223, 0.8)',
                            'rgba(28, 200, 138, 0.8)',
                            'rgba(54, 185, 204, 0.8)',
                            'rgba(246, 194, 62, 0.8)',
                            'rgba(133, 135, 150, 0.8)'
                        ],
                        borderColor: [
                            'rgb(78, 115, 223)',
                            'rgb(28, 200, 138)',
                            'rgb(54, 185, 204)',
                            'rgb(246, 194, 62)',
                            'rgb(133, 135, 150)'
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Number of Requests'
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `Requests: ${context.raw}`;
                                }
                            }
                        }
                    }
                }
            }
        );
        
        // Status Chart
        const statusChart = new Chart(
            document.getElementById('statusChart'),
            {
                type: 'doughnut',
                data: {
                    labels: ['Completed', 'In Progress', 'Pending', 'Cancelled'],
                    datasets: [{
                        data: [99, 22, 12, 6],
                        backgroundColor: [
                            'rgba(40, 167, 69, 0.8)',
                            'rgba(0, 123, 255, 0.8)',
                            'rgba(255, 193, 7, 0.8)',
                            'rgba(220, 53, 69, 0.8)'
                        ],
                        borderColor: [
                            'rgb(40, 167, 69)',
                            'rgb(0, 123, 255)',
                            'rgb(255, 193, 7)',
                            'rgb(220, 53, 69)'
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'right'
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const total = context.dataset.data.reduce((acc, val) => acc + val, 0);
                                    const percentage = Math.round((context.raw / total) * 100);
                                    return `${context.label}: ${context.raw} (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            }
        );
        
        // Buildings Chart
        const buildingsChart = new Chart(
            document.getElementById('buildingsChart'),
            {
                type: 'bar',
                data: {
                    labels: ['Building A', 'Building B', 'Building C', 'Building D', 'Other'],
                    datasets: [{
                        label: 'Number of Requests',
                        data: [38, 24, 32, 29, 6],
                        backgroundColor: [
                            'rgba(78, 115, 223, 0.8)',
                            'rgba(28, 200, 138, 0.8)',
                            'rgba(54, 185, 204, 0.8)',
                            'rgba(246, 194, 62, 0.8)',
                            'rgba(133, 135, 150, 0.8)'
                        ],
                        borderColor: [
                            'rgb(78, 115, 223)',
                            'rgb(28, 200, 138)',
                            'rgb(54, 185, 204)',
                            'rgb(246, 194, 62)',
                            'rgb(133, 135, 150)'
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Number of Requests'
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        }
                    }
                }
            }
        );
        
        // Resolution Time Chart
        const resolutionTimeChart = new Chart(
            document.getElementById('resolutionTimeChart'),
            {
                type: 'line',
                data: {
                    labels: ['Mar 1', 'Mar 2', 'Mar 3', 'Mar 4', 'Mar 5', 'Mar 6', 'Mar 7', 'Mar 8', 'Mar 9', 'Mar 10'],
                    datasets: [{
                        label: 'Avg. Resolution Time (hours)',
                        data: [36, 34, 32, 33, 30, 28, 29, 27, 26, 25],
                        borderColor: 'rgba(78, 115, 223, 1)',
                        backgroundColor: 'rgba(78, 115, 223, 0.1)',
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: false,
                            title: {
                                display: true,
                                text: 'Hours'
                            }
                        }
                    }
                }
            }
        );
    });
</script>
{% endblock %}